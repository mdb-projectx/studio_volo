<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>

<div id="checkout">
	<div class="page-title">
		<h1><?php echo $this->__('Checkout') ?></h1>
	</div>
	<script type="text/javascript" src="<?php echo $this->getJsUrl('varien/accordion.js') ?>"></script>
	<script type="text/javascript" src="<?php echo $this->getSkinUrl('js/opcheckout.js') ?>"></script>
	<ol class="opc" id="checkoutSteps">
	<?php $i=0; foreach($this->getSteps() as $_stepId => $_stepInfo): ?>
	<?php if (!$this->getChild($_stepId) || !$this->getChild($_stepId)->isShow()): continue; endif; $i++ ?>
		<li id="opc-<?php echo $_stepId ?>" class="section<?php echo !empty($_stepInfo['allow'])?' allow':'' ?><?php echo !empty($_stepInfo['complete'])?' saved':'' ?>">
			<div class="step-title">
				<span class="number"><?php echo $i ?></span>
				<h2><?php echo $_stepInfo['label'] ?></h2>
				<a href="#"><?php echo $this->__('Edit') ?></a>
			</div>
			<div id="checkout-step-<?php echo $_stepId ?>" class="step a-item" style="display:none;">
				<?php echo $this->getChildHtml($_stepId) ?>
			</div>
		</li>
	<?php endforeach ?>
	</ol>

</div>

<script type="text/javascript">
//<![CDATA[

    var accordion = new Accordion('checkoutSteps', '.step-title', true);
    <?php if($this->getActiveStep()): ?>
    accordion.openSection('opc-<?php echo $this->getActiveStep() ?>');	
    <?php endif ?>
    var checkout = new Checkout(accordion,{
        progress: '<?php echo $this->getUrl('checkout/onepage/progress') ?>',
        review: '<?php echo $this->getUrl('checkout/onepage/review') ?>',
        saveMethod: '<?php echo $this->getUrl('checkout/onepage/saveMethod') ?>',
        failure: '<?php echo $this->getUrl('checkout/cart') ?>'}
    );	
	
	<?php /* hide company + fax */ ?>
	$j('#shipping\\:company, #shipping\\:fax, #billing\\:company, #billing\\:fax').parent().parent().remove();
	
	<?php /* update sidebar summary every time button is click, and apply tax if needed */ ?>
	
	// add placeholder
	$j(document).ready(function() {
	//	mixpanel.track('Checkout');

		if( ($j('#shipping-address-select option:selected').text().indexOf("California") >= 0) || ($j('#shipping\\:region_id').val() == 12) || ($j('#shipping\\:same_as_billing').is(':checked') && $j('#billing\\:region_id').val() == 12) ) {
			console.log('1');
		} else {
			$j('#checkout-review #total').before( '<div class="adjustment"></div>');
			$j('#checkout-review .totals .adjustment').last().prepend( 'Tax <span class="value">$0.00</span>');
			console.log('2');
		}
		
		// on click	
		$j("#checkoutSteps button").on("click", function(event){
			console.log('3');
			var reviewUrl = '<?php echo $this->getUrl('checkout/onepage/review') ?>';
			
			$j.get(reviewUrl, function(data) {
				$j('#checkout-review .totals .adjustment').remove();
				$j('#checkout-review .totals #total').remove();
				
				var $dom = data;			
				$j($dom).find('.adjustment').each(function() {
					$j('#checkout-review .totals').append('<div class="adjustment"></div>');
					$j('#checkout-review .totals .adjustment').last().append($j(this).html());	
				});
				$j($dom).find('#total').each(function() {
					$j('#checkout-review .totals').append('<div id="total"></div>');
					$j('#checkout-review .totals #total').append($j(this).html());		
				});	
			}).error(function() { 			
				$j('#checkout-review .totals .adjustment').each(function() {
					if($j(this).html().indexOf("Tax") >= 0) {
						$j(this).remove();
						$j('#checkout-review #total .priceTaxed').remove();
						$j('#checkout-review #total .price').show();
					}
				});
				
				if($j('#discountAmount').length > 0) {
					var discount = parseFloat($j('#discountAmount .price').html().replace('$','').replace(',','').replace('-',''));
					var priceTotal = parseFloat($j('#checkout-review #total .price').html().replace('$','').replace(',','')) + discount;
				} else {
					var priceTotal = parseFloat($j('#checkout-review #total .price').html().replace('$','').replace(',',''));
				}
				
				if( ($j('#shipping-address-select option:selected').text().indexOf("California") >= 0) || ($j('#shipping\\:region_id').val() == 12) || ($j('#shipping\\:same_as_billing').is(':checked') && $j('#billing\\:region_id').val() == 12) ) {
					$j('#checkout-review #total').before( '<div class="adjustment"></div>');
					$j('#checkout-review .totals .adjustment').last().prepend( 'Tax <span class="value">$' + (priceTotal / 100 * 9).toFixed(2) + '</span>');
					$j('#checkout-review #total').append('<span class="priceTaxed"></span>');				
					if($j('#discountAmount').length > 0) {
						$j('#checkout-review #total .priceTaxed').html('$' + (parseFloat(priceTotal) + parseFloat(priceTotal / 100 * 9) - discount).toFixed(2));
					} else {
						$j('#checkout-review #total .priceTaxed').html('$' + (parseFloat(priceTotal) + parseFloat(priceTotal / 100 * 9)).toFixed(2));				
					}
					$j('#checkout-review #total .price').hide();
			console.log('4');
				} else {
					// add placeholder
					$j('#checkout-review #total').before( '<div class="adjustment"></div>');
					$j('#checkout-review .totals .adjustment').last().prepend( 'Tax <span class="value">$0.00</span>');
					
					$j('#checkout-review #total .priceTaxed').remove();
					$j('#checkout-review #total .price').show();
			console.log('5');
				}
			});
		});
	});
//]]>
</script>
